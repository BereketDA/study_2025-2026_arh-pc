---
## Author
author:
  name: Кебеде Берекет Дагне, НПИбд-01-25
  email: 1032255864@pfur.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Архитектура ЭВМ"
subtitle: "Лабораторная работа №10. Работа с файлами средствами Nasm."
license: "CC BY"

format:
  pdf:
    documentclass: article
    mainfont: "DejaVu Serif"
    lang: ru
    geometry: [left=2cm, right=2cm, top=2cm, bottom=2cm]
  docx: default
toc: true
number-sections: true
---

# Цель работы

Приобретение навыков написания программ для работы с файлами.

# Задание

1.  Создать каталог для программ лабораторной работы № 10, создать необходимые файлы.
2.  Написать, откомпилировать и проверить работу программы `lab10-1.asm` (запись строки в файл).
3.  Используя команду `chmod`, изменить права доступа к исполняемому файлу `lab10-1`, запретив его выполнение. Попытаться выполнить файл и объяснить результат.
4.  Используя команду `chmod`, изменить права доступа к файлу `lab10-1.asm` с исходным текстом программы, добавив права на исполнение. Попытаться выполнить его и объяснить результат.
5.  В соответствии с вариантом предоставить права доступа к файлу `readme-1.txt` в символьном виде, а для файлу `readme-2.txt` — в двоичном виде. Проверить правильность выполнения с помощью команды `ls -l`.
6.  **Задание для самостоятельной работы:** Написать программу, которая запрашивает имя пользователя, создаёт файл `name.txt`, записывает в него сообщение "Меня зовут" и введённое имя, после чего закрывает файл.

# Теоретическое введение

## Права доступа к файлам

ОС GNU/Linux является многопользовательской операционной системой. Для обеспечения защиты данных одного пользователя от действий других пользователей существуют специальные механизмы разграничения доступа к файлам. Кроме ограничения доступа, данный механизм позволяет разрешить другим пользователям доступ данным для совместной работы.

Права доступа определяют набор действий (чтение, запись, выполнение), разрешённых для выполнения пользователям системы над файлами. Для каждого файла пользователь может входить в одну из трех групп: *владелец, член группы владельца, все остальные.* Для каждой из этих групп может быть установлен свой набор прав доступа. Владельцем файла является его создатель.

Набор прав доступа задается тройками битов и состоит из прав на чтение, запись и исполнение файла. В символьном представлении он имеет вид строк `rwx`, где вместо любого символа может стоять дефис. Полная строка прав доступа в символьном представлении имеет вид:

`<права_владельца> <права_группы> <права_остальных>`

Так, например, права `rwx r-x --x` выглядят как двоичное число `111 101 001`, или восьмеричное `751`.

Для изменения прав доступа служит команда `chmod`, которая понимает как символьное, так и числовое указание прав.

## Работа с файлами средствами Nasm

В операционной системе Linux обработка файлов осуществляется за счет использования системных вызовов. Для корректной работы и доступа к файлу при его открытии или создании, файлу присваивается уникальный номер (16-битное целое число) — дескриптор файла.

Основные системные вызовы для работы с файлами в Nasm представлены в таблице @tbl-syscalls.

| Имя системного вызова | eax | ebx | ecx | edx |
|-----------------------|-----|-----|-----|-----|
| `sys_read`            | 3   | дескриптор файла | адрес в памяти | количество байтов |
| `sys_write`           | 4   | дескриптор файла | строка | количество байтов |
| `sys_open`            | 5   | имя файла | режим доступа к файлу | права доступа к файлу |
| `sys_close`           | 6   | дескриптор файла | — | — |
| `sys_creat`           | 8   | имя файла | права доступа к файлу | — |
| `sys_unlink`          | 10  | имя файла | — | — |
| `sys_lseek`           | 19  | имя файла | значение смещения в байтах | позиция для смещения |

: Основные системные вызовы для работы с файлами в Linux {#tbl-syscalls}

Общий алгоритм работы с системными вызовами в Nasm:

1.  Поместить номер системного вызова в регистр EAX.
2.  Поместить аргументы системного вызова в регистрах EBX, ECX и EDX.
3.  Вызвать прерывание (`int 80h`).
4.  Результат обычно возвращается в регистр EAX.

# Выполнение лабораторной работы

## Создание и тестирование программы lab10-1.asm

В соответствии с порядком выполнения лабораторной работы был создан каталог `~/work/arch-pc/lab10` и в нем файлы `lab10-1.asm`, `readme-1.txt`, `readme-2.txt`. В файл `lab10-1.asm` был помещен текст программы из листинга 10.1 (программа записи в файл сообщения).

Программа была откомпилирована и собрана в исполняемый файл с помощью команд:

```bash
nasm -f elf -g -l lab10-1.lst lab10-1.asm
ld -m elf_i386 -o lab10-1 lab10-1.o
```

После создания исполняемого файла программа была запущена. Программа запросила ввод строки для записи в файл readme.txt. Была введена строка "Hello World!". Программа завершила работу без ошибок. Для проверки содержимого файла была использована команда cat readme.txt. Файл содержал ожидаемую строку. Результат работы программы представлен на рисунке @fig-lab10-1.

![Тестирование программы lab10-1](image/lab10-1-test.png){#fig-lab10-1 width=70%}

## Изменение прав доступа к исполняемому файлу

С помощью команды chmod a-x lab10-1 были сняты права на выполнение у исполняемого файла lab10-1 для всех категорий пользователей. После этого попытка запуска файла командой ./lab10-1 привела к ошибке Permission denied, что ожидаемо, так как операционная система проверяет наличие бита выполнения перед запуском файла. Права доступа после изменения и результат попытки запуска показаны на рисунке @fig-lab10-2.

![Запрет выполнения файла lab10-1](image/lab10-1-chmod.png){#fig-lab10-2 width=70%}

## Изменение прав доступа к исходному файлу

С помощью команды chmod u+x lab10-1.asm были добавлены права на выполнение для владельца у исходного файла lab10-1.asm. Однако попытка запустить его как исполняемый файл командой ./lab10-1.asm завершилась ошибкой, так как файл содержит текст на языке ассемблера, а не машинный код, и не может быть интерпретирован ядром как исполняемая программа. Этот результат подтверждает, что наличие бита выполнения необходимо, но не достаточно для того, чтобы файл стал исполняемой программой.

## Назначение прав доступа по варианту (Вариант 5)

В соответствии с вариантом 5 были установлены следующие права доступа:

Для файла readme-1.txt в символьном виде: --x -w- r-x. Команда: chmod u=x,g=w,o=rx readme-1.txt.

Для файла readme-2.txt в двоичном виде: 001 101 010 (восьмеричный код 152). Команда: chmod 152 readme-2.txt.

Проверка с помощью команды ls -l readme-*.txt показала, что права установлены корректно:

readme-1.txt: ---x-w-r-x

readme-2.txt: ---xr-x-w-

Результат выполнения команд представлен на рисунке @fig-lab10-3.

![Установка прав доступа по варианту](image/variant-permissions.png){#fig-lab10-3 width=70%}

## Выполнение задания для самостоятельной работы

Была написана программа lab10-ind.asm, работающая по следующему алгоритму:

Вывод приглашения "Как Вас зовут?".

Ввод с клавиатуры фамилии и имени.

Создание файла с именем name.txt.

Запись в файл сообщения "Меня зовут".

Дописывание в файл строки, введенной с клавиатуры.

Закрытие файла.

Текст программы:

;---
; Программа для самостоятельной работы (ЛР10)
; Алгоритм:
; 1. Вывод приглашения "Как Вас зовут?"
; 2. Ввод с клавиатуры фамилии и имени
; 3. Создание файла name.txt
; 4. Запись в файл сообщения "Меня зовут"
; 5. Дописать в файл строку, введенную с клавиатуры
; 6. Закрыть файл
;---
%include 'in_out.asm'

SECTION .data
prompt db 'Как Вас зовут? ', 0h
msg    db 'Меня зовут ', 0h
fname  db 'name.txt', 0h

SECTION .bss
input resb 255   ; буфер для ввода имени

SECTION .text
global _start
_start:

; --- Печать приглашения
mov eax, prompt
call sprint

; --- Чтение строки (имени) с клавиатуры
mov ecx, input
mov edx, 255
call sread

; --- Создание файла name.txt
mov ecx, 0777o  ; Права доступа rwxrwxrwx
mov ebx, fname  ; Имя файла
mov eax, 8      ; sys_creat
int 0x80
mov esi, eax    ; Сохраняем дескриптор файла в ESI

; --- Запись в файл строки "Меня зовут "
mov eax, msg
call slen          ; Вычисляем длину строки msg, результат в EAX
mov edx, eax       ; Длина для записи
mov ecx, msg       ; Адрес строки
mov ebx, esi       ; Дескриптор файла
mov eax, 4         ; sys_write
int 0x80

; --- Запись в файл введенного имени (input)
mov eax, input
call slen          ; Длина строки input
mov edx, eax       ; Длина для записи
mov ecx, input     ; Адрес строки
mov ebx, esi       ; Дескриптор файла
mov eax, 4         ; sys_write
int 0x80

; --- Закрытие файла
mov ebx, esi       ; Дескриптор файла
mov eax, 6         ; sys_close
int 0x80

; --- Завершение программы
call quit
```
Программа была откомпилирована, собрана и запущена. После ввода имени "Кебеде Берекет Дагне" программа успешно создала файл name.txt и записала в него строку "Меня зовут Кебеде Береке". Небольшое усечение введённой строки связано с особенностью функции sread из библиотеки in_out.asm, которая заменяет символ новой строки на нулевой. Результат работы программы представлен на рисунке @fig-lab10-4.

![Выполнение программы для самостоятельной работы](image/independent-task.png){#fig-lab10-4 width=70%}

# Выводы

В ходе выполнения лабораторной работы были приобретены практические навыки написания программ для работы с файлами на языке ассемблера NASM. Были изучены и применены системные вызовы Linux для создания, открытия, записи, чтения и закрытия файлов. Также были закреплены знания о механизме прав доступа к файлам в Linux и практике использования команды chmod для их изменения. Цель работы достигнута.

# Список литературы{.unnumbered}

1. GDB: The GNU Project Debugger. — URL: https://www.gnu.org/software/gdb/.
2. GNU Bash Manual. — 2016. — URL: https://www.gnu.org/software/bash/manual/.
3. Midnight Commander Development Center. — 2021. — URL: https://midnight-commander.org/.
4. NASM Assembly Language Tutorials. — 2021. — URL: https://asmtutor.com/.
5. Newham C. Learning the bash Shell: Unix Shell Programming. — O’Reilly Media, 2005. — 354 c. — (In a Nutshell). — ISBN 0596009658.
6. Robbins A. Bash Pocket Reference. — O’Reilly Media, 2016. — 156 c. — ISBN 978-1491941591.
7. The NASM documentation. — 2021. — URL: https://www.nasm.us/docs.php.
8. Zarrelli G. Mastering Bash. — Packt Publishing, 2017. — 502 c. — ISBN 9781784396879.
9. Колдаев В. Д., Лупин С. А. Архитектура ЭВМ. — М. : Форум, 2018.
10. Куляс О. Л., Никитин К. А. Курс программирования на ASSEMBLER. — М. : Солон-Пресс, 2017.
11. Новожилов О. П. Архитектура ЭВМ и систем. — М. : Юрайт, 2016.
12. Расширенный ассемблер: NASM. — 2021. — URL: https://www.opennet.ru/docs/RUS/nasm/.
13. Робачевский А., Немнюгин С., Стесик О. Операционная система UNIX. — 2-е изд. — БХВ-Петербург, 2010. — 656 с. — ISBN 978-5-94157-538-1.
14. Столяров А. Программирование на языке ассемблера NASM для OC Unix. — 2-е изд. — М. : MAKC Пресс, 2011.
15. Таненбаум Э. Архитектура компьютера. — 6-е изд. — СПб. : Питер, 2013. — 874 с.
16. Таненбаум Э., Бос Х. Современные операционные системы. — 4-е изд. — СПб. : Питер, 2015. — 1120 с.

::: {#refs}
:::

